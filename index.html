<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SocialSense: Neural Interface</title>

    <!-- FONTS & ICONS -->
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --neon-blue: #00f3ff;
        --neon-red: #ff0055;
        --neon-green: #00ff9d;
        --neon-yellow: #ffcc00;
        --glass: rgba(10, 20, 30, 0.85);
      }

      body {
        margin: 0;
        background-color: #050505;
        color: white;
        font-family: "Inter", sans-serif;
        overflow: hidden;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* --- VIDEO LAYER --- */
      #container {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: radial-gradient(circle at center, #1a2a3a 0%, #000 100%);
      }

      video {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1); /* Mirror for natural feel */
        opacity: 0.4;
      }

      canvas {
        position: absolute;
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
      }

      /* --- HUD UI --- */
      #hud {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        display: grid;
        grid-template-columns: 300px 1fr 300px;
        grid-template-rows: 80px 1fr 100px;
        padding: 20px;
        box-sizing: border-box;
      }

      /* TOP HEADER */
      .header {
        grid-column: 1 / -1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .brand {
        font-family: "JetBrains Mono", monospace;
        font-weight: 800;
        font-size: 24px;
        color: var(--neon-blue);
        letter-spacing: -1px;
      }
      .status-badge {
        background: rgba(0, 243, 255, 0.1);
        border: 1px solid var(--neon-blue);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        color: var(--neon-blue);
        animation: pulse 2s infinite;
      }

      /* LEFT PANEL - BIOMETRICS */
      .panel {
        background: var(--glass);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        height: fit-content;
        align-self: center;
      }

      .metric {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .label {
        font-size: 11px;
        color: #8899ac;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .bar-container {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
      }
      .bar-fill {
        height: 100%;
        width: 0%;
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .val-text {
        font-family: "JetBrains Mono";
        font-size: 14px;
        color: white;
        align-self: flex-end;
      }

      /* CENTER - MAIN ALERT */
      .center-stage {
        grid-column: 2;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      #dynamic-island {
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid var(--neon-blue);
        padding: 20px 40px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        gap: 15px;
        transform: scale(0.9);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
      }
      #dynamic-island.active {
        transform: scale(1);
        opacity: 1;
      }
      #alert-icon {
        font-size: 24px;
      }
      #alert-text {
        font-size: 18px;
        font-weight: 700;
        color: white;
        white-space: nowrap;
      }

      /* RIGHT PANEL - LOGS */
      .log-panel {
        font-family: "JetBrains Mono";
        font-size: 10px;
        color: var(--neon-green);
        overflow-y: hidden;
        opacity: 0.7;
      }
      .log-entry {
        margin-bottom: 4px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        padding-bottom: 2px;
      }

      /* BOTTOM - CAPTIONS */
      .footer {
        grid-column: 1 / -1;
        display: flex;
        justify-content: center;
        align-items: flex-end;
      }
      #captions {
        background: rgba(0, 0, 0, 0.6);
        color: #ffeb3b;
        padding: 10px 30px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 500;
        opacity: 0;
        transition: opacity 0.3s;
      }

      /* LOADING OVERLAY */
      #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top-color: var(--neon-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      button {
        background: var(--neon-blue);
        color: #000;
        border: none;
        padding: 15px 40px;
        font-weight: 800;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: 0.2s;
      }
      button:hover {
        box-shadow: 0 0 20px var(--neon-blue);
        transform: translateY(-2px);
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes pulse {
        0% {
          opacity: 0.6;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.6;
        }
      }
    </style>

    <!-- MEDIAPIPE LIBRARIES -->
    <script type="module">
      import {
        FaceLandmarker,
        HandLandmarker,
        FilesetResolver,
      } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

      const video = document.getElementById("webcam");
      const canvas = document.getElementById("output_canvas");
      const ctx = canvas.getContext("2d");
      const dynamicIsland = document.getElementById("dynamic-island");
      const alertText = document.getElementById("alert-text");
      const alertIcon = document.getElementById("alert-icon");
      const captionBox = document.getElementById("captions");
      const logBox = document.getElementById("sys-log");

      let faceLandmarker, handLandmarker;
      let lastVideoTime = -1;
      let lastSpokenPhrase = "";
      let isSpeaking = false;

      // --- SYSTEM INITIALIZATION ---
      window.initApp = async function () {
        document.getElementById("start-btn").innerText =
          "BOOTING NEURAL ENGINE...";

        // 1. Audio Check
        speak("Social Sense Systems Online. Calibrating sensors.");

        // 2. Vision Models
        const vision = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
        );

        faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
            delegate: "GPU",
          },
          outputFaceBlendshapes: true,
          runningMode: "VIDEO",
          numFaces: 3, // Group detection
        });

        handLandmarker = await HandLandmarker.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
            delegate: "GPU",
          },
          runningMode: "VIDEO",
          numHands: 2,
        });

        // 3. Camera
        const stream = await navigator.mediaDevices.getUserMedia({
          video: true,
        });
        video.srcObject = stream;
        video.addEventListener("loadeddata", predictWebcam);

        document.getElementById("loader").style.display = "none";
      };

      // --- MAIN LOOP ---
      async function predictWebcam() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        if (lastVideoTime !== video.currentTime) {
          lastVideoTime = video.currentTime;
          let startTimeMs = performance.now();

          // RUN INFERENCE
          if (faceLandmarker && handLandmarker) {
            const faceResult = faceLandmarker.detectForVideo(
              video,
              startTimeMs
            );
            const handResult = handLandmarker.detectForVideo(
              video,
              startTimeMs
            );

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // --- THE CORE BRAIN ---
            analyzeScene(faceResult, handResult);
          }
        }
        requestAnimationFrame(predictWebcam);
      }

      // --- INTELLIGENCE ENGINE ---
      function analyzeScene(faces, hands) {
        let priorityEvent = null; // We only speak the most important thing
        let debugLog = "";

        // 1. HANDSHAKE PHYSICS (Hand Tracking)
        if (hands.landmarks.length > 0) {
          const hand = hands.landmarks[0];
          drawHand(hand);

          // Logic: Is palm open? Is it extending?
          // Simple hack check: Hand Y is usually lower than Face Y for handshake
          // We use Hand[0] (Wrist) vs Hand[9] (Middle Finger MCP)

          // Detection
          priorityEvent = {
            type: "HANDSHAKE",
            msg: "Someone is reaching out to shake your hand.",
            icon: "ü§ù",
            color: "#00f3ff",
          };
        }

        // 2. FACE ANALYSIS
        if (faces.faceBlendshapes.length > 0) {
          const mainFace = faces.faceBlendshapes[0].categories;
          drawFaceHUD(faces.faceLandmarks[0]); // Draw Iron Man HUD

          // --- DATA EXTRACTION ---
          const get = (name) =>
            mainFace.find((s) => s.categoryName === name)?.score || 0;

          const smile = (get("mouthSmileLeft") + get("mouthSmileRight")) / 2;
          const frown =
            (get("mouthFrownLeft") +
              get("mouthFrownRight") +
              get("browInnerUp")) /
            3;
          const lookDown =
            (get("eyeLookDownLeft") + get("eyeLookDownRight")) / 2;
          const blink = (get("eyeBlinkLeft") + get("eyeBlinkRight")) / 2;

          // --- UPDATE BARS ---
          updateMetric("happy", smile * 100, "#00ff9d");
          updateMetric("sad", frown * 100 * 1.5, "#00f3ff");
          updateMetric("focus", (1 - lookDown) * 100, "#ffcc00");

          // --- COMPLEX EVENT LOGIC ---

          // A. CRYING (Sadness > Threshold)
          if (frown > 0.45) {
            priorityEvent = {
              type: "CRYING",
              msg: "You seem very sad. Are you crying?",
              icon: "üò¢",
              color: "#00f3ff",
            };
          }

          // B. GROUP DISTRACTION (Phone Checking)
          // If we see faces, and they are looking down
          if (lookDown > 0.6) {
            priorityEvent = {
              type: "DISTRACTED",
              msg: "They are looking down at their phone.",
              icon: "üì±",
              color: "#ffcc00",
            };
            // If multiple faces (group)
            if (faces.faceBlendshapes.length > 1) {
              priorityEvent.msg =
                "The group looks distracted; they are checking phones.";
            }
          }

          // C. HAPPY (Lowest Priority)
          if (!priorityEvent && smile > 0.5) {
            priorityEvent = {
              type: "SMILING",
              msg: "They are smiling warmly at you.",
              icon: "üòä",
              color: "#00ff9d",
            };
          }

          debugLog = `E: ${(smile * 100).toFixed(0)}% | F: ${(
            frown * 100
          ).toFixed(0)}% | GazeY: ${lookDown.toFixed(2)}`;
        } else {
          debugLog = "SCANNING ENVIRONMENT...";
        }

        // --- EXECUTION (UI & AUDIO) ---
        if (priorityEvent) {
          showAlert(priorityEvent.msg, priorityEvent.icon, priorityEvent.color);
          smartSpeak(priorityEvent.msg);
          log("EVENT DETECTED: " + priorityEvent.type);
        } else {
          hideAlert();
        }

        // Log update
        if (Math.random() > 0.8) log(debugLog);
      }

      // --- AUDIO ENGINE ---
      function smartSpeak(text) {
        // Prevent spamming the same phrase 50 times a second
        if (text === lastSpokenPhrase || isSpeaking) return;

        // Cooldown check (don't speak again for 4 seconds unless it's urgent)
        // But wait... if phrase changed, we speak immediately.

        isSpeaking = true;
        lastSpokenPhrase = text;

        // Show Captions
        captionBox.style.opacity = 1;
        captionBox.innerText = `AI Whisper: "${text}"`;

        // Speak
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1.1; // Efficient speed
        u.pitch = 1.0;

        u.onend = () => {
          isSpeaking = false;
          setTimeout(() => {
            captionBox.style.opacity = 0;
            if (lastSpokenPhrase === text) lastSpokenPhrase = ""; // Allow repeat after delay
          }, 3000);
        };

        window.speechSynthesis.speak(u);
      }

      function speak(t) {
        window.speechSynthesis.speak(new SpeechSynthesisUtterance(t));
      }

      // --- VISUALIZATIONS ---
      function showAlert(text, icon, color) {
        dynamicIsland.classList.add("active");
        dynamicIsland.style.borderColor = color;
        dynamicIsland.style.boxShadow = `0 0 30px ${color}40`;
        alertText.innerText = text;
        alertText.style.color = color;
        alertIcon.innerText = icon;
      }

      function hideAlert() {
        dynamicIsland.classList.remove("active");
      }

      function updateMetric(id, val, color) {
        const el = document.getElementById("bar-" + id);
        el.style.width = Math.min(val, 100) + "%";
        el.style.backgroundColor = color;
        document.getElementById("val-" + id).innerText = Math.floor(val) + "%";
      }

      function log(msg) {
        const div = document.createElement("div");
        div.className = "log-entry";
        div.innerText = `> ${msg}`;
        logBox.prepend(div);
        if (logBox.children.length > 10) logBox.lastChild.remove();
      }

      // --- AR DRAWING ---
      function drawFaceHUD(face) {
        // Sci-Fi Reticle around Face
        // Center is approximately Nose Tip (Index 1)
        const nose = face[1];
        const x = nose.x * canvas.width;
        const y = nose.y * canvas.height;

        ctx.strokeStyle = "rgba(0, 243, 255, 0.3)";
        ctx.lineWidth = 1;

        // Circle
        ctx.beginPath();
        ctx.arc(x, y, 90, 0, 2 * Math.PI);
        ctx.stroke();

        // Brackets
        ctx.beginPath();
        ctx.moveTo(x - 100, y - 50);
        ctx.lineTo(x - 100, y + 50);
        ctx.moveTo(x + 100, y - 50);
        ctx.lineTo(x + 100, y + 50);
        ctx.stroke();
      }

      function drawHand(hand) {
        ctx.strokeStyle = "#00f3ff";
        ctx.lineWidth = 2;
        ctx.fillStyle = "#00f3ff";

        // Connect points
        for (let i = 0; i < hand.length; i++) {
          const x = hand[i].x * canvas.width;
          const y = hand[i].y * canvas.height;
          ctx.beginPath();
          ctx.arc(x, y, 3, 0, 2 * Math.PI);
          ctx.fill();
        }
      }
    </script>
  </head>
  <body>
    <div id="loader">
      <div class="spinner"></div>
      <h1
        style="font-family: 'JetBrains Mono'; color: white; margin-bottom: 10px"
      >
        SOCIAL SENSE
      </h1>
      <p style="color: #888; margin-bottom: 30px">
        Initializing Multimodal AI...
      </p>
      <button id="start-btn" onclick="initApp()">CONNECT NEURAL LINK</button>
    </div>

    <div id="container">
      <video id="webcam" autoplay playsinline muted></video>
      <canvas id="output_canvas"></canvas>

      <div id="hud">
        <div class="header">
          <div class="brand">
            SOCIAL SENSE <span style="font-size: 12px; opacity: 0.5">PRO</span>
          </div>
          <div class="status-badge">‚óè LIVE TRACKING</div>
        </div>

        <div class="panel">
          <div class="metric">
            <div class="label">Happiness / Engagement</div>
            <div class="bar-container">
              <div id="bar-happy" class="bar-fill"></div>
            </div>
            <div id="val-happy" class="val-text">0%</div>
          </div>
          <div class="metric">
            <div class="label">Distress / Sadness</div>
            <div class="bar-container">
              <div id="bar-sad" class="bar-fill"></div>
            </div>
            <div id="val-sad" class="val-text">0%</div>
          </div>
          <div class="metric">
            <div class="label">Attention Focus</div>
            <div class="bar-container">
              <div id="bar-focus" class="bar-fill"></div>
            </div>
            <div id="val-focus" class="val-text">0%</div>
          </div>
        </div>

        <div class="center-stage">
          <div id="dynamic-island">
            <div id="alert-icon">‚ö†Ô∏è</div>
            <div id="alert-text">Analyzing...</div>
          </div>
        </div>

        <div class="panel log-panel" id="sys-log">
          <div class="log-entry">> System Ready</div>
        </div>

        <div class="footer">
          <div id="captions">AI Whisper: "System Calibrated"</div>
        </div>
      </div>
    </div>
  </body>
</html>
