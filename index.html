<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SocialSense OMNI</title>
    <style>
      /* SCI-FI AR INTERFACE */
      body {
        margin: 0;
        background: #000;
        overflow: hidden;
        font-family: "Courier New", Courier, monospace;
      }

      #container {
        position: relative;
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle, #1a1a1a 0%, #000 90%);
      }

      /* LAYERS */
      video {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.6;
        transform: scaleX(-1);
      }
      canvas {
        position: absolute;
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
      }

      /* HUD OVERLAY */
      #hud-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        padding: 30px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      /* TOP BAR */
      .top-bar {
        display: flex;
        justify-content: space-between;
        border-bottom: 2px solid rgba(0, 255, 255, 0.3);
        padding-bottom: 10px;
      }
      .logo {
        font-size: 24px;
        font-weight: bold;
        color: #00f3ff;
        text-shadow: 0 0 10px #00f3ff;
      }
      .live-tag {
        background: red;
        color: white;
        padding: 2px 8px;
        font-size: 12px;
        border-radius: 4px;
        animation: pulse 1s infinite;
      }

      /* BOTTOM SUBTITLES */
      #subtitle-box {
        text-align: center;
        font-size: 24px;
        color: #fff;
        text-shadow: 0 0 5px #000;
        background: rgba(0, 0, 0, 0.5);
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 20px;
        min-height: 40px;
      }

      /* SIDE PANELS */
      #analysis-panel {
        position: absolute;
        right: 30px;
        top: 100px;
        width: 250px;
        background: rgba(0, 20, 40, 0.8);
        border: 1px solid #00f3ff;
        padding: 15px;
        border-radius: 8px;
      }

      .metric {
        margin-bottom: 15px;
      }
      .metric-label {
        font-size: 12px;
        color: #aaa;
        display: flex;
        justify-content: space-between;
      }
      .metric-val {
        color: #fff;
        font-weight: bold;
      }
      .bar-bg {
        width: 100%;
        height: 5px;
        background: #333;
        margin-top: 5px;
      }
      .bar-fill {
        height: 100%;
        width: 0%;
        transition: width 0.2s;
      }

      /* LOADING SCREEN */
      #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #00f3ff;
      }
      button {
        margin-top: 20px;
        padding: 15px 40px;
        background: transparent;
        border: 2px solid #00f3ff;
        color: #00f3ff;
        font-size: 18px;
        cursor: pointer;
        font-family: inherit;
        font-weight: bold;
        transition: 0.3s;
      }
      button:hover {
        background: #00f3ff;
        color: #000;
        box-shadow: 0 0 20px #00f3ff;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
    </style>

    <!-- MEDIAPIPE IMPORTS -->
    <script type="module">
      import {
        FaceLandmarker,
        FilesetResolver,
        DrawingUtils,
      } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

      const video = document.getElementById("webcam");
      const canvas = document.getElementById("ar-canvas");
      const ctx = canvas.getContext("2d");
      const subtitleBox = document.getElementById("subtitle-box");

      // Metrics
      let blinkCount = 0;
      let lastBlinkState = false;
      let blinkStart = Date.now();
      let bpm = 0;
      let faceLandmarker;
      let recognition;

      window.initSystem = async function () {
        document.getElementById("btn-start").innerText = "INITIALIZING AI...";

        // 1. Setup Speech Recognition (Chrome/Edge)
        if ("webkitSpeechRecognition" in window) {
          recognition = new webkitSpeechRecognition();
          recognition.continuous = true;
          recognition.interimResults = true;
          recognition.lang = "en-US";

          recognition.onresult = (event) => {
            let final = "";
            for (let i = event.resultIndex; i < event.results.length; ++i) {
              if (event.results[i].isFinal)
                final += event.results[i][0].transcript;
              else
                subtitleBox.innerText =
                  "Listening: " + event.results[i][0].transcript;
            }
            if (final) {
              subtitleBox.innerText = "User said: " + final;
              // Basic Sentiment analysis simulation
              if (final.includes("happy") || final.includes("good"))
                updateSentiment("POSITIVE");
              else if (final.includes("sad") || final.includes("bad"))
                updateSentiment("NEGATIVE");
            }
          };
          recognition.start();
        } else {
          subtitleBox.innerText = "Speech API not supported in this browser.";
        }

        // 2. Setup Vision AI
        const filesetResolver = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
        );
        faceLandmarker = await FaceLandmarker.createFromOptions(
          filesetResolver,
          {
            baseOptions: {
              modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
              delegate: "GPU",
            },
            outputFaceBlendshapes: true,
            runningMode: "VIDEO",
            numFaces: 1,
          }
        );

        // 3. Start Camera
        const stream = await navigator.mediaDevices.getUserMedia({
          video: true,
        });
        video.srcObject = stream;
        video.addEventListener("loadeddata", predictWebcam);

        document.getElementById("loader").style.display = "none";
        speak("Omni System Online. Tracking active.");
      };

      let lastVideoTime = -1;
      async function predictWebcam() {
        // Resize canvas to match video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        if (lastVideoTime !== video.currentTime) {
          lastVideoTime = video.currentTime;
          let startTimeMs = performance.now();

          if (faceLandmarker) {
            const result = faceLandmarker.detectForVideo(video, startTimeMs);

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (result.faceLandmarks.length > 0) {
              // AR DRAWING
              drawARHUD(result.faceLandmarks[0]);

              // ANALYSIS
              const shapes = result.faceBlendshapes[0].categories;
              analyzeFace(shapes);
            }
          }
        }
        requestAnimationFrame(predictWebcam);
      }

      function drawARHUD(landmarks) {
        // Get Nose Tip coordinates (Index 1)
        const nose = landmarks[1];
        const x = nose.x * canvas.width;
        const y = nose.y * canvas.height;

        // Draw Sci-Fi Target Circle
        ctx.beginPath();
        ctx.arc(x, y, 80, 0, 2 * Math.PI);
        ctx.strokeStyle = "rgba(0, 243, 255, 0.5)";
        ctx.lineWidth = 3;
        ctx.stroke();

        // Draw Rotating Reticle (Animation simulation)
        let time = Date.now() / 500;
        ctx.beginPath();
        ctx.arc(x, y, 90, time, time + 1.5);
        ctx.strokeStyle = "#00f3ff";
        ctx.lineWidth = 2;
        ctx.stroke();

        // Draw ID Tag
        ctx.font = "16px Courier New";
        ctx.fillStyle = "#00f3ff";
        ctx.fillText("TARGET: HUMAN", x + 100, y - 50);
        ctx.fillText("ID: UNKNOWN", x + 100, y - 30);
      }

      function analyzeFace(shapes) {
        const getScore = (name) =>
          shapes.find((s) => s.categoryName === name)?.score || 0;

        // 1. EMOTION LOGIC
        const smile =
          (getScore("mouthSmileLeft") + getScore("mouthSmileRight")) / 2;
        const anger = getScore("browDownLeft");

        updateBar("happy", smile * 100, "#0f0");
        updateBar("anger", anger * 100, "#f00");

        // 2. BLINK RATE (NERVOUSNESS)
        const blinkLeft = getScore("eyeBlinkLeft");
        const blinkRight = getScore("eyeBlinkRight");
        const isBlinking = blinkLeft > 0.5 && blinkRight > 0.5;

        if (isBlinking && !lastBlinkState) {
          blinkCount++;
          document.getElementById("raw-blinks").innerText = blinkCount;
        }
        lastBlinkState = isBlinking;

        // Calculate BPM every 5 seconds
        if (Date.now() - blinkStart > 5000) {
          bpm = Math.round((blinkCount / 5) * 60); // Extrapolate to minute
          document.getElementById("val-bpm").innerText = bpm + " BPM";

          let nervousPct = Math.min((bpm / 30) * 100, 100); // 30 BPM is high
          updateBar("nervous", nervousPct, "#ffaa00");

          if (bpm > 25) {
            document.getElementById("status-tag").innerText =
              "STATUS: NERVOUS / LYING?";
            document.getElementById("status-tag").style.color = "orange";
          } else {
            document.getElementById("status-tag").innerText = "STATUS: CALM";
            document.getElementById("status-tag").style.color = "#00f3ff";
          }

          blinkCount = 0;
          blinkStart = Date.now();
        }
      }

      function updateBar(id, val, color) {
        const el = document.getElementById("bar-" + id);
        el.style.width = val + "%";
        el.style.backgroundColor = color;
      }

      function updateSentiment(text) {
        document.getElementById("val-sentiment").innerText = text;
      }

      let lastSpeakTime = 0;
      function speak(text) {
        if (Date.now() - lastSpeakTime > 3000) {
          const u = new SpeechSynthesisUtterance(text);
          window.speechSynthesis.speak(u);
          lastSpeakTime = Date.now();
        }
      }
    </script>
  </head>
  <body>
    <div id="loader">
      <h1>SOCIAL SENSE <span style="color: #fff">OMNI</span></h1>
      <p>Loading: Neural Network • Speech Engine • AR Module</p>
      <button id="btn-start" onclick="initSystem()">INITIALIZE</button>
    </div>

    <div id="container">
      <video id="webcam" autoplay playsinline muted></video>
      <canvas id="ar-canvas"></canvas>

      <div id="hud-layer">
        <div class="top-bar">
          <div class="logo">OMNI HUD v4.0</div>
          <div class="live-tag">REC ●</div>
        </div>

        <div id="analysis-panel">
          <div
            class="metric-label"
            id="status-tag"
            style="font-size: 14px; margin-bottom: 10px; color: #00f3ff"
          >
            STATUS: SCANNING
          </div>

          <div class="metric">
            <div class="metric-label"><span>HAPPINESS</span></div>
            <div class="bar-bg">
              <div id="bar-happy" class="bar-fill"></div>
            </div>
          </div>

          <div class="metric">
            <div class="metric-label"><span>ANGER / STRESS</span></div>
            <div class="bar-bg">
              <div id="bar-anger" class="bar-fill"></div>
            </div>
          </div>

          <div class="metric">
            <div class="metric-label">
              <span>NERVOUSNESS (Blink Rate)</span>
              <span id="val-bpm" class="metric-val">0 BPM</span>
            </div>
            <div class="bar-bg">
              <div id="bar-nervous" class="bar-fill"></div>
            </div>
            <div style="font-size: 10px; color: #555; text-align: right">
              Raw Blinks: <span id="raw-blinks">0</span>
            </div>
          </div>

          <div class="metric">
            <div class="metric-label">
              <span>SPEECH SENTIMENT</span>
              <span id="val-sentiment" class="metric-val">NEUTRAL</span>
            </div>
          </div>
        </div>

        <div id="subtitle-box">Waiting for speech input...</div>
      </div>
    </div>
  </body>
</html>
